function makeUniqueTasks(level, opChoice){
  const ops = ['+','-','*','/'];
  const ranges = {
    '+':[10,20,50,100,200],
    '-':[10,20,50,100,200],
    '*':[5,10,12,15,20],
    '/':[2,5,10,12,15]
  };

  let uniqueTasks = [];
  let attempts = 0; // Schutz vor Endlosschleife
  while(uniqueTasks.length < TOTAL && attempts < 1000){
    attempts++;
    const op = opChoice==='all'?ops[randInt(ops.length)]:opChoice;
    const max = ranges[op][level-1];
    let a,b,res;

    switch(op){
      case '+': a=randInt(max)+1; b=randInt(max)+1; res=a+b; break;
      case '-': a=randInt(max)+1; b=randInt(a+1); res=a-b; break;
      case '*': a=randInt(max)+1; b=randInt(max)+1; res=a*b; break;
      case '/': b=randInt(max-1)+1; let q=randInt(max)+1; a=b*q; res=q; break;
    }

    // Prüfen ob Aufgabe schon existiert
    let key = `${a},${op},${b}`;
    let duplicate = uniqueTasks.some(t => `${t.a},${t.op},${t.b}` === key);
    if(!duplicate){
      uniqueTasks.push({a,b,op,res});
    }
  }
  return uniqueTasks;
}

function startTest(){
  tasks = makeUniqueTasks(levelEl.value, opEl.value);
  current = 0; correct = 0; wrong = 0; chartEl.style.display='none';
  startBtn.disabled=true; settingsEl.classList.add('small');
  showTask();

  if(timerInput.value){
    let remaining = parseInt(timerInput.value);
    timerEl.textContent = `⏱ Zeit: ${remaining}s`;
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      remaining--;
      timerEl.textContent = `⏱ Zeit: ${remaining}s`;
      if(remaining<=0){
        clearInterval(timerInterval);
        finishTest();
      }
    },1000);
  }
}

function showTask(){
  if(current >= tasks.length){
    finishTest(); return;
  }
  const t = tasks[current];
  exerciseEl.innerHTML = `
    <div class="task">${t.a} ${t.op} ${t.b} = </div>
    <input type="number" id="answer" />
    <button id="okBtn">✅ Prüfen</button>
  `;
  const answerInput = document.getElementById('answer');
  document.getElementById('okBtn').onclick = checkAnswer;

  // Enter-Taste bestätigt die Aufgabe
  answerInput.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
      checkAnswer();
    }
  });

  answerInput.focus();
}
